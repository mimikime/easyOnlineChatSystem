<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>聊天系统</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7fa;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .sidebar .section {
            margin-bottom: 20px;
        }

        .sidebar .section h3 {
            font-size: 14px;
            margin-bottom: 8px;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 5px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin: 4px 0;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .sidebar ul li:hover {
            background-color: #34495e;
        }

        .sidebar .actions {
            margin-top: 20px;
        }

        .sidebar .actions button {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            border: none;
            background-color: #1abc9c;
            color: white;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .sidebar .actions button:hover {
            background-color: #16a085;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .chat-header {
            font-size: 18px;
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        .chat-toolbar {
            display: flex;
            justify-content: flex-end;
            margin: 10px 0;
            gap: 10px;
        }

        .chat-toolbar button {
            padding: 6px 12px;
            border: none;
            background-color: #95a5a6;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .chat-toolbar button:hover {
            background-color: #7f8c8d;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .chat-input textarea {
            flex-grow: 1;
            height: 60px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            resize: none;
        }

        .chat-input button {
            padding: 0 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .chat-input button:hover {
            background-color: #2980b9;
        }
    </style>
</head>


<!-- 添加好友模态框 -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <h3>添加好友</h3>
        <input type="text" id="friendUsername" placeholder="请输入用户名">
        <button onclick="submitAddFriend()">发送请求</button>
    </div>
</div>

<!-- 好友验证弹窗 -->
<div id="verifyModal" class="modal">
    <div class="modal-content">
        <h3>好友验证请求</h3>
        <ul id="requestList" style="list-style: none; padding: 0;"></ul>
        <button onclick="closeVerifyModal()">关闭</button>
    </div>
</div>
<!-- 新增分组模态框 -->
<div id="friendGroupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('friendGroupModal')">&times;</span>
        <h3>新增好友分组</h3>
        <input type="text" id="friendGroupNameInput" placeholder="请输入分组名称">
        <button onclick="submitFriendGroup()">确认添加</button>
    </div>
</div>

<!-- 新建群模态框 -->
<div id="chatGroupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('chatGroupModal')">&times;</span>
        <h3>新建聊天群组</h3>
        <input type="text" id="chatGroupNameInput" placeholder="请输入群名称">
        <button onclick="submitChatGroup()">确认创建</button>
    </div>
</div>



<body>
<div class="main-container">
    <div class="sidebar">
        <div>
            <h2>用户：<span th:text="${username}">用户名</span></h2>
            <div class="section">
                <h3>好友分组</h3>
                <div id="friend-groups-container"></div>
            </div>


            <div class="section">
                <h3>群组</h3>
                <ul>
                    <li th:each="group : ${chatGroups}" th:text="${group.name}">群组名</li>
                </ul>
            </div>

        </div>
        <div class="actions">
            <button onclick="showCreateFriendGroupModal()">新增分组</button>
            <button onclick="showCreateGroupModal()">新建群</button>
            <button onclick="showVerifyModal()">好友验证</button>
            <button onclick="showAddFriendModal()">添加好友</button>
            <button onclick="alert('添加群')">添加群</button>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            当前聊天对象：<span id="chat-target">未选择</span>
        </div>
        <div class="chat-toolbar">
            <button onclick="alert('查看历史记录')">历史记录</button>
            <button onclick="alert('下载聊天记录')">下载记录</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- 聊天消息区域 -->
        </div>
        <div class="chat-input">
            <textarea placeholder="输入消息..."></textarea>
            <button>发送</button>
        </div>
    </div>
</div>
<script>
    function showAddFriendModal() {
        document.getElementById("addModal").style.display = "block";
    }

    function submitAddFriend() {
        const username = document.getElementById("friendUsername").value.trim();
        if (!username) {
            alert("请输入用户名");
            return;
        }

        fetch('/friend/request?targetUsername=' + encodeURIComponent(username), {
            method: 'POST'
        })
            .then(resp => resp.text())
            .then(msg => alert(msg))
            .catch(err => alert("请求失败：" + err));

        document.getElementById("addModal").style.display = "none";
    }

    window.onclick = function(event) {
        const modal = document.getElementById("addModal");
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }

    function showVerifyModal() {
        const modal = document.getElementById("verifyModal");
        const list = document.getElementById("requestList");
        list.innerHTML = "";

        fetch('/friend/pending')
            .then(resp => resp.json())
            .then(data => {
                if (data.length === 0) {
                    list.innerHTML = "<li>暂无好友请求</li>";
                } else {
                    data.forEach(req => {
                        const item = document.createElement("li");
                        item.style.marginBottom = "10px";
                        item.innerHTML =
                            "来自用户：" + req.senderUsername + " " +
                            "<button onclick='handleRequest(" + req.id + ", true)'>同意</button> " +
                            "<button onclick='handleRequest(" + req.id + ", false)'>拒绝</button>";
                        list.appendChild(item);
                    });
                }
                modal.style.display = "block";
            })
            .catch(err => {
                alert("加载请求失败：" + err);
            });
    }

    function handleRequest(id, accept) {
        const url = accept ? "/friend/accept?requestId=" + id : "/friend/reject?requestId=" + id;
        fetch(url, { method: 'POST' })
            .then(resp => resp.text())
            .then(msg => {
                alert(msg);
                showVerifyModal(); // 刷新请求列表
            });
    }

    function closeVerifyModal() {
        document.getElementById("verifyModal").style.display = "none";
    }


        function loadFriendGroups() {
        fetch('/friend/groups')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('friend-groups-container');
                container.innerHTML = '';

                for (const groupName in data) {
                    const groupDiv = document.createElement('div');
                    const groupTitle = document.createElement('h4');
                    groupTitle.innerText = groupName;
                    groupDiv.appendChild(groupTitle);

                    const ul = document.createElement('ul');
                    data[groupName].forEach(friend => {
                        const li = document.createElement('li');
                        li.innerText = friend;
                        ul.appendChild(li);
                    });

                    groupDiv.appendChild(ul);
                    container.appendChild(groupDiv);
                }
            })
            .catch(e => console.error("加载好友分组失败", e));
    }
        window.onload = loadFriendGroups;

        function showCreateFriendGroupModal() {
        document.getElementById('friendGroupModal').style.display = 'block';
    }

        function showCreateGroupModal() {
        document.getElementById('chatGroupModal').style.display = 'block';
    }

        function submitFriendGroup() {
        const name = document.getElementById('friendGroupNameInput').value.trim();
        if (!name) return alert("请输入分组名称");

        fetch('/friend/group/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'groupName=' + encodeURIComponent(name)
    })
        .then(res => res.text())
        .then(msg => {
        alert(msg);
        document.getElementById('friendGroupModal').style.display = 'none';
        location.reload();  // 刷新界面
    });
    }

        function submitChatGroup() {
        const name = document.getElementById('chatGroupNameInput').value.trim();
        if (!name) return alert("请输入群名称");

        fetch('/group/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'groupName=' + encodeURIComponent(name)
    })
        .then(res => res.text())
        .then(msg => {
        alert(msg);
        document.getElementById('chatGroupModal').style.display = 'none';
        location.reload();  // 刷新界面
    });
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

</script>


</body>
</html>